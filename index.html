<!doctype html>
<html lang="en" ng-app="listaPessoa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js" crossorigin="anonymous"></script>

</head>

<body ng-controller="pessoaController">

<style>
    .t-table {
        display: flex;
        flex-direction: row;
        justify-content: center;
        padding: 30px;
    }
</style>

<h4 ng-bind="app"></h4>

<form>
    <input type="hidden" ng-model="pessoa.id" id="id" name="id" value="">
    <label>Nome:</label>
    <input name="nome" ng-model="pessoa.nome" id="nome" value="" type="text"><br><br>
    <label>Nascimento:</label>
    <input name="nascimento" ng-model="pessoa.nascimento" id="nascimento" value="" type="text"><br><br>
    <label>Pai:</label>
    <input name="pai" id="pai" ng-model="pessoa.pai" type="text"><br><br>
    <label>Mae:</label>
    <input name="mae" id="mae" ng-model="pessoa.mae" type="text"><br><br>
    <label>Cep:</label>
    <input name="cep" ng-model="pessoa.cep" type= "text" id="cep" size="10" maxlength="9"><br><br>
    <label>Endere√ßo:</label>
    <input id="rua" name="endereco"  ng-model="pessoa.endereco" type="text"><br><br>
    <label>Bairro:</label>
    <input id="bairro" name="bairro" ng-model="pessoa.bairro" type="text"><br><br>
    <label>Cidade:</label>
    <input id="cidade" name="cidade" ng-model="pessoa.cidade" type="text"><br><br>
    <label>Uf:</label>
    <input id="uf" name="uf" value="" ng-model="pessoa.uf" type="text"><br><br>
    <label>Telefone:</label>
    <input id="telefone" name="telefone" ng-model="pessoa.telefone" type="text"><br><br>
    <label>Celular:</label>
    <input name="celular" id="celular" ng-model="pessoa.celular" type="text"><br><br>
    <label>Email:</label>
    <input name="email" id="email" ng-model="pessoa.email" type="text"><br><br>

    <label>Sexo:</label>
    <select name="sexo" id="sexo">
        <option ng-model="pessoa.sexo" ng-selected="pessoa.sexo == ''"></option>
        <option ng-model="pessoa.sexo" ng-selected="pessoa.sexo == M">Masculino</option>
        <option ng-model="pessoa.sexo" ng-selected="pessoa.sexo = F">Feminino</option>
    </select><br><br>
    <button ng-click="gravar()" class="btn btn-primary">Enviar</button>
</form>
<script>
        angular.module("listaPessoa",[]);
        angular.module("listaPessoa").controller("pessoaController", ($scope, $http) => {
            $scope.pessoa = {};

            const url = window.location.href;
            const valorDaUrl = new URL(url);
            const paramId = valorDaUrl.searchParams.get('id');
            console.log(paramId);

            $scope.buscaPessoa = () => {
                $http({
                    method: "POST",
                    url: "/data/controllers/PessoaController.php?acao=buscarId",
                    data: {
                        id:paramId
                    }
                }).then((response) => {
                    if (response.error){
                        console.log(response);
                    }
                    return response.data;
                }).then((response) => {
                    console.log(response);
                    $scope.pessoa = response.dados;
                }).catch((error) => {
                    console.log(error);
                })
            };

            if (paramId > 0) {
                $scope.buscaPessoa();
                console.log('Atualizar');
            } else {
                salvar();
                console.log('Salvar');
            }

            $scope.gravar = function(){
                if($scope.pessoa.id > 0){
                    $scope.atualizar();
                } else {
                    $scope.salvar();
                }
            }

            $scope.salvar = () => {
                $http({
                    method: "POST",
                    url: "/data/controllers/PessoaController.php?acao=salvar",
                    data: $scope.pessoa
                }).then((response) => {
                    if (response.error){
                        console.log(response);
                    }
                }).then((response) => {
                    delete $scope.pessoa;
                    location.href = 'formPessoa.php';
                    console.log(response);
                }).catch((error) => {
                    console.log(error);
                })
            };

            $scope.atualizar = () => {
                $http({
                    method: "POST",
                    url: "/data/controllers/PessoaController.php?acao=atualizar",
                    data: $scope.pessoa
                }).then((response) => {
                    if (response.error){
                        console.log(response);
                    }
                    return response.data
                }).then((response) => {
                    // delete $scope.pessoa;
                    location.href = 'listaPessoa.php';
                    console.log(response);
                }).catch((error) => {
                    console.log(error);
                })
            };

        });
</script>
</body>
</html>